<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AniStream - Watch Anime Online</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    <style>
        :root {
            --primary: #6a55fa;
            --primary-dark: #5a4ce6;
            --secondary: #ff6b6b;
            --dark: #1a1a2e;
            --dark-light: #16213e;
            --light: #f8f9fa;
            --gray: #6c757d;
            --success: #28a745;
            --danger: #dc3545;
            --warning: #fd7e14;
            --info: #17a2b8;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Poppins', sans-serif;
        }

        body {
            background-color: var(--dark);
            color: var(--light);
            overflow-x: hidden;
        }

        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: var(--dark-light);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--primary);
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--primary-dark);
        }

        /* Header */
        header {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            padding: 1rem 2rem;
            background-color: rgba(26, 26, 46, 0.9);
            backdrop-filter: blur(10px);
            z-index: 1000;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
            transition: all 0.3s ease;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--light);
            text-decoration: none;
        }

        .logo i {
            color: var(--primary);
        }

        .search-container {
            position: relative;
            width: 40%;
            max-width: 500px;
        }

        .search-input {
            width: 100%;
            padding: 0.8rem 1.5rem;
            border-radius: 50px;
            border: none;
            background-color: var(--dark-light);
            color: var(--light);
            font-size: 1rem;
            outline: none;
            transition: all 0.3s ease;
        }

        .search-input:focus {
            box-shadow: 0 0 0 2px var(--primary);
        }

        .search-results {
            position: absolute;
            top: 100%;
            left: 0;
            width: 100%;
            max-height: 400px;
            overflow-y: auto;
            background-color: var(--dark-light);
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            z-index: 100;
            display: none;
            margin-top: 0.5rem;
        }

        .search-results.active {
            display: block;
        }

        .search-result-item {
            padding: 0.8rem 1rem;
            display: flex;
            align-items: center;
            gap: 1rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .search-result-item:hover {
            background-color: rgba(106, 85, 250, 0.2);
        }

        .search-result-item img {
            width: 50px;
            height: 70px;
            object-fit: cover;
            border-radius: 5px;
        }

        .search-result-item-info {
            flex: 1;
        }

        .search-result-item-title {
            font-weight: 600;
            margin-bottom: 0.2rem;
        }

        .search-result-item-meta {
            font-size: 0.8rem;
            color: var(--gray);
            display: flex;
            gap: 0.5rem;
        }

        .nav-links {
            display: flex;
            align-items: center;
            gap: 1.5rem;
        }

        .nav-link {
            color: var(--light);
            text-decoration: none;
            font-weight: 500;
            transition: all 0.2s ease;
            position: relative;
        }

        .nav-link:hover {
            color: var(--primary);
        }

        .nav-link.active {
            color: var(--primary);
        }

        .nav-link.active::after {
            content: '';
            position: absolute;
            bottom: -5px;
            left: 0;
            width: 100%;
            height: 2px;
            background-color: var(--primary);
        }

        .user-actions {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .btn {
            padding: 0.6rem 1.2rem;
            border-radius: 50px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            border: none;
            outline: none;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        .btn-primary {
            background-color: var(--primary);
            color: var(--light);
        }

        .btn-primary:hover {
            background-color: var(--primary-dark);
        }

        .btn-outline {
            background-color: transparent;
            color: var(--light);
            border: 1px solid var(--light);
        }

        .btn-outline:hover {
            background-color: var(--light);
            color: var(--dark);
        }

        .btn-icon {
            padding: 0.6rem;
            border-radius: 50%;
            background-color: var(--dark-light);
            color: var(--light);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .btn-icon:hover {
            background-color: var(--primary);
        }

        /* Main Content */
        main {
            margin-top: 80px;
            padding: 2rem;
        }

        .section-title {
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: 1.5rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .section-title a {
            font-size: 0.9rem;
            color: var(--primary);
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 0.3rem;
        }

        .section-title a:hover {
            text-decoration: underline;
        }

        /* Anime Cards */
        .anime-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: 1.5rem;
            margin-bottom: 3rem;
        }

        .anime-card {
            position: relative;
            border-radius: 10px;
            overflow: hidden;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .anime-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.3);
        }

        .anime-card-poster {
            position: relative;
            width: 100%;
            height: 250px;
            overflow: hidden;
        }

        .anime-card-poster img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: all 0.3s ease;
        }

        .anime-card:hover .anime-card-poster img {
            transform: scale(1.05);
        }

        .anime-card-badge {
            position: absolute;
            top: 10px;
            right: 10px;
            background-color: var(--primary);
            color: var(--light);
            padding: 0.3rem 0.6rem;
            border-radius: 50px;
            font-size: 0.7rem;
            font-weight: 600;
            z-index: 1;
        }

        .anime-card-dub-badge {
            position: absolute;
            top: 10px;
            left: 10px;
            background-color: var(--secondary);
            color: var(--light);
            padding: 0.3rem 0.6rem;
            border-radius: 50px;
            font-size: 0.7rem;
            font-weight: 600;
            z-index: 1;
        }

        .anime-card-info {
            padding: 1rem;
            background-color: var(--dark-light);
        }

        .anime-card-title {
            font-size: 0.9rem;
            font-weight: 600;
            margin-bottom: 0.3rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .anime-card-meta {
            display: flex;
            justify-content: space-between;
            font-size: 0.8rem;
            color: var(--gray);
        }

        /* Spotlight */
        .spotlight {
            position: relative;
            height: 500px;
            border-radius: 10px;
            overflow: hidden;
            margin-bottom: 3rem;
        }

        .spotlight-bg {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-size: cover;
            background-position: center;
            filter: brightness(0.4);
            z-index: -1;
        }

        .spotlight-content {
            position: relative;
            height: 100%;
            display: flex;
            align-items: center;
            padding: 0 3rem;
            z-index: 1;
        }

        .spotlight-poster {
            width: 250px;
            height: 350px;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.5);
            flex-shrink: 0;
            margin-right: 2rem;
        }

        .spotlight-poster img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .spotlight-info {
            max-width: 600px;
        }

        .spotlight-title {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 1rem;
            line-height: 1.2;
        }

        .spotlight-jtitle {
            font-size: 1.2rem;
            color: var(--gray);
            margin-bottom: 1rem;
        }

        .spotlight-description {
            margin-bottom: 1.5rem;
            line-height: 1.6;
            display: -webkit-box;
            -webkit-line-clamp: 4;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .spotlight-meta {
            display: flex;
            gap: 1rem;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
        }

        .spotlight-meta-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.9rem;
        }

        .spotlight-meta-item i {
            color: var(--primary);
        }

        .spotlight-actions {
            display: flex;
            gap: 1rem;
        }

        /* Top 10 */
        .top10-list {
            display: flex;
            gap: 1.5rem;
            overflow-x: auto;
            padding-bottom: 1rem;
            margin-bottom: 3rem;
        }

        .top10-list::-webkit-scrollbar {
            height: 6px;
        }

        .top10-item {
            position: relative;
            min-width: 200px;
            height: 300px;
            border-radius: 10px;
            overflow: hidden;
            flex-shrink: 0;
            cursor: pointer;
        }

        .top10-item-poster {
            width: 100%;
            height: 100%;
        }

        .top10-item-poster img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .top10-item-rank {
            position: absolute;
            top: 10px;
            left: 10px;
            font-size: 2rem;
            font-weight: 700;
            color: var(--light);
            text-shadow: 2px 2px 5px rgba(0, 0, 0, 0.5);
            -webkit-text-stroke: 2px var(--primary);
        }

        .top10-item-info {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            padding: 1rem;
            background: linear-gradient(transparent, rgba(0, 0, 0, 0.8));
        }

        .top10-item-title {
            font-weight: 600;
            margin-bottom: 0.3rem;
        }

        .top10-item-meta {
            font-size: 0.8rem;
            color: var(--gray);
        }

        /* Anime Details */
        .anime-details {
            display: none;
            padding: 2rem 0;
        }

        .anime-details-container {
            display: flex;
            gap: 2rem;
        }

        .anime-details-poster {
            width: 300px;
            height: 450px;
            border-radius: 10px;
            overflow: hidden;
            flex-shrink: 0;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.3);
        }

        .anime-details-poster img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .anime-details-info {
            flex: 1;
        }

        .anime-details-title {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
        }

        .anime-details-jtitle {
            font-size: 1.2rem;
            color: var(--gray);
            margin-bottom: 1rem;
        }

        .anime-details-meta {
            display: flex;
            gap: 1rem;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
        }

        .anime-details-meta-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.9rem;
        }

        .anime-details-meta-item i {
            color: var(--primary);
        }

        .anime-details-description {
            margin-bottom: 1.5rem;
            line-height: 1.6;
        }

        .anime-details-stats {
            display: flex;
            gap: 2rem;
            margin-bottom: 1.5rem;
        }

        .anime-details-stat {
            text-align: center;
        }

        .anime-details-stat-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary);
        }

        .anime-details-stat-label {
            font-size: 0.8rem;
            color: var(--gray);
        }

        .anime-details-actions {
            display: flex;
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .anime-details-section {
            margin-bottom: 2rem;
        }

        .anime-details-section-title {
            font-size: 1.2rem;
            font-weight: 600;
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .anime-details-genres {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
            margin-bottom: 1.5rem;
        }

        .anime-details-genre {
            background-color: var(--primary);
            color: var(--light);
            padding: 0.3rem 0.8rem;
            border-radius: 50px;
            font-size: 0.8rem;
        }

        .anime-details-characters {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 1.5rem;
        }

        .anime-details-character {
            text-align: center;
        }

        .anime-details-character-image {
            width: 100%;
            height: 180px;
            border-radius: 10px;
            overflow: hidden;
            margin-bottom: 0.5rem;
        }

        .anime-details-character-image img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .anime-details-character-name {
            font-weight: 600;
            margin-bottom: 0.2rem;
        }

        .anime-details-character-role {
            font-size: 0.8rem;
            color: var(--gray);
        }

        .anime-details-episodes {
            background-color: var(--dark-light);
            border-radius: 10px;
            overflow: hidden;
        }

        .anime-details-episode {
            padding: 1rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.2s ease;
        }

        .anime-details-episode:hover {
            background-color: rgba(106, 85, 250, 0.1);
        }

        .anime-details-episode-number {
            font-weight: 600;
            color: var(--primary);
            width: 50px;
        }

        .anime-details-episode-title {
            flex: 1;
        }

        .anime-details-episode-actions {
            display: flex;
            gap: 0.5rem;
        }

        /* Watch Page */
        .watch-page {
            display: none;
            padding: 2rem 0;
        }

        .watch-container {
            display: flex;
            flex-direction: column;
            gap: 2rem;
        }

        .watch-player-container {
            position: relative;
            width: 100%;
            padding-bottom: 56.25%; /* 16:9 aspect ratio */
            background-color: #000;
            border-radius: 10px;
            overflow: hidden;
        }

        .watch-player {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }

        .watch-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .watch-title {
            font-size: 1.2rem;
            font-weight: 600;
        }

        .watch-episode-selector {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .watch-server-selector {
            display: flex;
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .watch-server {
            padding: 0.5rem 1rem;
            background-color: var(--dark-light);
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .watch-server:hover {
            background-color: var(--primary);
        }

        .watch-server.active {
            background-color: var(--primary);
        }

        .watch-episodes {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(60px, 1fr));
            gap: 0.5rem;
            margin-top: 1rem;
        }

        .watch-episode {
            padding: 0.5rem;
            background-color: var(--dark-light);
            border-radius: 5px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .watch-episode:hover {
            background-color: var(--primary);
        }

        .watch-episode.active {
            background-color: var(--primary);
        }

        /* Loading */
        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 200px;
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 5px solid rgba(106, 85, 250, 0.3);
            border-radius: 50%;
            border-top-color: var(--primary);
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        /* Responsive */
        @media (max-width: 992px) {
            .spotlight {
                height: auto;
                padding: 2rem 0;
            }

            .spotlight-content {
                flex-direction: column;
                padding: 2rem;
            }

            .spotlight-poster {
                margin-right: 0;
                margin-bottom: 2rem;
            }

            .anime-details-container {
                flex-direction: column;
            }

            .anime-details-poster {
                width: 100%;
                max-width: 300px;
                margin: 0 auto;
            }
        }

        @media (max-width: 768px) {
            header {
                padding: 1rem;
            }

            .search-container {
                width: 60%;
            }

            .nav-links {
                display: none;
            }

            .anime-list {
                grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            }

            .top10-item {
                min-width: 150px;
                height: 250px;
            }
        }

        @media (max-width: 576px) {
            .search-container {
                width: 100%;
                position: absolute;
                top: 100%;
                left: 0;
                padding: 1rem;
                background-color: var(--dark);
                display: none;
            }

            .search-container.active {
                display: block;
            }

            .user-actions .btn-text {
                display: none;
            }

            .anime-list {
                grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
                gap: 1rem;
            }

            .anime-card-poster {
                height: 200px;
            }

            .spotlight-title {
                font-size: 1.8rem;
            }

            .spotlight-jtitle {
                font-size: 1rem;
            }

            .spotlight-actions {
                flex-direction: column;
            }

            .spotlight-actions .btn {
                width: 100%;
            }
        }

        /* Transitions */
        .fade-enter-active, .fade-leave-active {
            transition: opacity 0.3s ease;
        }

        .fade-enter, .fade-leave-to {
            opacity: 0;
        }

        .slide-up-enter-active, .slide-up-leave-active {
            transition: all 0.3s ease;
        }

        .slide-up-enter, .slide-up-leave-to {
            opacity: 0;
            transform: translateY(20px);
        }

        /* Custom scrollbar for dropdowns */
        .custom-scrollbar {
            scrollbar-width: thin;
            scrollbar-color: var(--primary) var(--dark-light);
        }

        .custom-scrollbar::-webkit-scrollbar {
            width: 6px;
        }

        .custom-scrollbar::-webkit-scrollbar-track {
            background: var(--dark-light);
        }

        .custom-scrollbar::-webkit-scrollbar-thumb {
            background-color: var(--primary);
            border-radius: 6px;
        }
    </style>
</head>
<body>
    <header>
        <a href="#" class="logo" onclick="loadHomePage(event)">
            <i class="fas fa-play-circle"></i>
            <span>AniStream</span>
        </a>

        <div class="search-container">
            <input type="text" class="search-input" placeholder="Search anime..." oninput="searchAnime(this.value)">
            <div class="search-results custom-scrollbar"></div>
        </div>

        <nav class="nav-links">
            <a href="#" class="nav-link active" onclick="loadHomePage(event)">Home</a>
            <a href="#" class="nav-link" onclick="loadAZListPage(event, 'all')">A-Z List</a>
            <a href="#" class="nav-link" onclick="loadCategoryPage(event, 'top-airing')">Popular</a>
            <a href="#" class="nav-link" onclick="loadCategoryPage(event, 'movie')">Movies</a>
            <a href="#" class="nav-link" onclick="loadSchedulePage(event)">Schedule</a>
        </nav>

        <div class="user-actions">
            <button class="btn btn-icon" onclick="toggleSearch()">
                <i class="fas fa-search"></i>
            </button>
            <button class="btn btn-outline">
                <i class="fas fa-user"></i>
                <span class="btn-text">Login</span>
            </button>
        </div>
    </header>

    <main>
        <!-- Home Page -->
        <div id="home-page">
            <div class="spotlight">
                <div class="spotlight-bg"></div>
                <div class="spotlight-content">
                    <div class="spotlight-poster">
                        <img src="" alt="Spotlight Anime" id="spotlight-poster">
                    </div>
                    <div class="spotlight-info">
                        <h1 class="spotlight-title" id="spotlight-title"></h1>
                        <h2 class="spotlight-jtitle" id="spotlight-jtitle"></h2>
                        <p class="spotlight-description" id="spotlight-description"></p>
                        <div class="spotlight-meta" id="spotlight-meta"></div>
                        <div class="spotlight-actions">
                            <button class="btn btn-primary" onclick="watchAnime()">
                                <i class="fas fa-play"></i> Watch Now
                            </button>
                            <button class="btn btn-outline" onclick="showAnimeDetails()">
                                <i class="fas fa-info-circle"></i> Details
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <h2 class="section-title">
                Latest Episodes
                <a href="#" onclick="loadCategoryPage(event, 'recently-updated')">
                    View All <i class="fas fa-chevron-right"></i>
                </a>
            </h2>
            <div class="anime-list" id="latest-episodes"></div>

            <h2 class="section-title">
                Top 10 Anime
                <a href="#" onclick="loadCategoryPage(event, 'most-popular')">
                    View All <i class="fas fa-chevron-right"></i>
                </a>
            </h2>
            <div class="top10-list" id="top10-anime"></div>

            <h2 class="section-title">
                Trending Now
                <a href="#" onclick="loadCategoryPage(event, 'trending')">
                    View All <i class="fas fa-chevron-right"></i>
                </a>
            </h2>
            <div class="anime-list" id="trending-anime"></div>

            <h2 class="section-title">
                Top Airing
                <a href="#" onclick="loadCategoryPage(event, 'top-airing')">
                    View All <i class="fas fa-chevron-right"></i>
                </a>
            </h2>
            <div class="anime-list" id="top-airing"></div>

            <h2 class="section-title">
                AI Recommendations
                <a href="#" onclick="loadAIRecommendations()">
                    Refresh <i class="fas fa-sync-alt"></i>
                </a>
            </h2>
            <div class="anime-list" id="ai-recommendations"></div>
        </div>

        <!-- A-Z List Page -->
        <div id="azlist-page" style="display: none;">
            <h2 class="section-title">
                <span id="azlist-title">All Anime</span>
                <a href="#" onclick="loadHomePage(event)">
                    <i class="fas fa-arrow-left"></i> Back to Home
                </a>
            </h2>

            <div style="display: flex; gap: 0.5rem; margin-bottom: 1.5rem; flex-wrap: wrap;">
                <button class="btn btn-outline" onclick="loadAZListPage(event, 'all')">All</button>
                <button class="btn btn-outline" onclick="loadAZListPage(event, 'other')">Other</button>
                <button class="btn btn-outline" onclick="loadAZListPage(event, '0-9')">0-9</button>
                <button class="btn btn-outline" onclick="loadAZListPage(event, 'a')">A</button>
                <button class="btn btn-outline" onclick="loadAZListPage(event, 'b')">B</button>
                <button class="btn btn-outline" onclick="loadAZListPage(event, 'c')">C</button>
                <button class="btn btn-outline" onclick="loadAZListPage(event, 'd')">D</button>
                <button class="btn btn-outline" onclick="loadAZListPage(event, 'e')">E</button>
                <button class="btn btn-outline" onclick="loadAZListPage(event, 'f')">F</button>
                <button class="btn btn-outline" onclick="loadAZListPage(event, 'g')">G</button>
                <button class="btn btn-outline" onclick="loadAZListPage(event, 'h')">H</button>
                <button class="btn btn-outline" onclick="loadAZListPage(event, 'i')">I</button>
                <button class="btn btn-outline" onclick="loadAZListPage(event, 'j')">J</button>
                <button class="btn btn-outline" onclick="loadAZListPage(event, 'k')">K</button>
                <button class="btn btn-outline" onclick="loadAZListPage(event, 'l')">L</button>
                <button class="btn btn-outline" onclick="loadAZListPage(event, 'm')">M</button>
                <button class="btn btn-outline" onclick="loadAZListPage(event, 'n')">N</button>
                <button class="btn btn-outline" onclick="loadAZListPage(event, 'o')">O</button>
                <button class="btn btn-outline" onclick="loadAZListPage(event, 'p')">P</button>
                <button class="btn btn-outline" onclick="loadAZListPage(event, 'q')">Q</button>
                <button class="btn btn-outline" onclick="loadAZListPage(event, 'r')">R</button>
                <button class="btn btn-outline" onclick="loadAZListPage(event, 's')">S</button>
                <button class="btn btn-outline" onclick="loadAZListPage(event, 't')">T</button>
                <button class="btn btn-outline" onclick="loadAZListPage(event, 'u')">U</button>
                <button class="btn btn-outline" onclick="loadAZListPage(event, 'v')">V</button>
                <button class="btn btn-outline" onclick="loadAZListPage(event, 'w')">W</button>
                <button class="btn btn-outline" onclick="loadAZListPage(event, 'x')">X</button>
                <button class="btn btn-outline" onclick="loadAZListPage(event, 'y')">Y</button>
                <button class="btn btn-outline" onclick="loadAZListPage(event, 'z')">Z</button>
            </div>

            <div class="anime-list" id="azlist-anime"></div>

            <div style="display: flex; justify-content: center; gap: 1rem; margin: 2rem 0;">
                <button class="btn btn-outline" id="azlist-prev" onclick="changeAZListPage('prev')" disabled>
                    <i class="fas fa-chevron-left"></i> Previous
                </button>
                <span id="azlist-page-info">Page 1 of 1</span>
                <button class="btn btn-outline" id="azlist-next" onclick="changeAZListPage('next')" disabled>
                    Next <i class="fas fa-chevron-right"></i>
                </button>
            </div>
        </div>

        <!-- Category Page -->
        <div id="category-page" style="display: none;">
            <h2 class="section-title">
                <span id="category-title">Category</span>
                <a href="#" onclick="loadHomePage(event)">
                    <i class="fas fa-arrow-left"></i> Back to Home
                </a>
            </h2>

            <div class="anime-list" id="category-anime"></div>

            <div style="display: flex; justify-content: center; gap: 1rem; margin: 2rem 0;">
                <button class="btn btn-outline" id="category-prev" onclick="changeCategoryPage('prev')" disabled>
                    <i class="fas fa-chevron-left"></i> Previous
                </button>
                <span id="category-page-info">Page 1 of 1</span>
                <button class="btn btn-outline" id="category-next" onclick="changeCategoryPage('next')" disabled>
                    Next <i class="fas fa-chevron-right"></i>
                </button>
            </div>
        </div>

        <!-- Schedule Page -->
        <div id="schedule-page" style="display: none;">
            <h2 class="section-title">
                Anime Schedule
                <a href="#" onclick="loadHomePage(event)">
                    <i class="fas fa-arrow-left"></i> Back to Home
                </a>
            </h2>

            <div style="display: flex; gap: 1rem; margin-bottom: 1.5rem;">
                <input type="date" id="schedule-date" class="search-input" style="width: auto;">
                <button class="btn btn-primary" onclick="loadSchedule()">
                    <i class="fas fa-calendar-alt"></i> View Schedule
                </button>
            </div>

            <div id="schedule-anime"></div>
        </div>

        <!-- Anime Details Page -->
        <div id="anime-details" class="anime-details">
            <h2 class="section-title">
                <span id="details-title">Anime Details</span>
                <a href="#" onclick="goBack()">
                    <i class="fas fa-arrow-left"></i> Back
                </a>
            </h2>

            <div class="anime-details-container">
                <div class="anime-details-poster">
                    <img src="" alt="Anime Poster" id="details-poster">
                </div>

                <div class="anime-details-info">
                    <h1 class="anime-details-title" id="details-name"></h1>
                    <h2 class="anime-details-jtitle" id="details-jname"></h2>

                    <div class="anime-details-meta" id="details-meta"></div>

                    <div class="anime-details-stats">
                        <div class="anime-details-stat">
                            <div class="anime-details-stat-value" id="details-rating">-</div>
                            <div class="anime-details-stat-label">Rating</div>
                        </div>
                        <div class="anime-details-stat">
                            <div class="anime-details-stat-value" id="details-quality">-</div>
                            <div class="anime-details-stat-label">Quality</div>
                        </div>
                        <div class="anime-details-stat">
                            <div class="anime-details-stat-value" id="details-episodes">-</div>
                            <div class="anime-details-stat-label">Episodes</div>
                        </div>
                    </div>

                    <div class="anime-details-actions">
                        <button class="btn btn-primary" onclick="watchAnime()">
                            <i class="fas fa-play"></i> Watch Now
                        </button>
                        <button class="btn btn-outline" id="details-favorite">
                            <i class="far fa-heart"></i> Favorite
                        </button>
                    </div>

                    <p class="anime-details-description" id="details-description"></p>

                    <div class="anime-details-section">
                        <h3 class="anime-details-section-title">Genres</h3>
                        <div class="anime-details-genres" id="details-genres"></div>
                    </div>

                    <div class="anime-details-section">
                        <h3 class="anime-details-section-title">More Info</h3>
                        <div id="details-more-info"></div>
                    </div>
                </div>
            </div>

            <div class="anime-details-section">
                <h3 class="anime-details-section-title">Episodes</h3>
                <div class="anime-details-episodes" id="details-episodes-list"></div>
            </div>

            <div class="anime-details-section">
                <h3 class="anime-details-section-title">Recommended</h3>
                <div class="anime-list" id="details-recommended"></div>
            </div>
        </div>

        <!-- Watch Page -->
        <div id="watch-page" class="watch-page">
            <h2 class="section-title">
                <span id="watch-anime-title">Watching Anime</span>
                <a href="#" onclick="goBack()">
                    <i class="fas fa-arrow-left"></i> Back
                </a>
            </h2>

            <div class="watch-container">
                <div class="watch-player-container">
                    <video class="watch-player" id="video-player" controls></video>
                </div>

                <div class="watch-info">
                    <h3 class="watch-title" id="watch-episode-title">Episode 1</h3>
                    <div class="watch-episode-selector">
                        <button class="btn btn-outline" id="prev-episode" onclick="changeEpisode('prev')">
                            <i class="fas fa-chevron-left"></i> Prev
                        </button>
                        <span id="episode-number">1</span>
                        <button class="btn btn-outline" id="next-episode" onclick="changeEpisode('next')">
                            Next <i class="fas fa-chevron-right"></i>
                        </button>
                    </div>
                </div>

                <div class="watch-server-selector" id="server-selector"></div>

                <h3 class="section-title">Episodes</h3>
                <div class="watch-episodes" id="episode-list"></div>
            </div>
        </div>

        <!-- Loading Indicator -->
        <div class="loading" id="loading" style="display: none;">
            <div class="loading-spinner"></div>
        </div>
    </main>

    <script>
        // Global variables
        let currentAnimeId = '';
        let currentEpisodeId = '';
        let currentEpisodeNumber = 1;
        let currentServer = 'hd-1';
        let currentCategory = 'sub';
        let currentPage = 'home';
        let azListCurrentPage = 1;
        let azListTotalPages = 1;
        let azListSortOption = 'all';
        let categoryCurrentPage = 1;
        let categoryTotalPages = 1;
        let categoryName = '';
        let homeData = null;
        let animeDetails = null;
        let episodesList = [];
        let serversList = [];
        let videoPlayer = null;
        let hls = null;

        // Initialize the app
        document.addEventListener('DOMContentLoaded', function() {
            videoPlayer = document.getElementById('video-player');
            loadHomePage();
            setupEventListeners();
        });

        // Set up event listeners
        function setupEventListeners() {
            // Handle back/forward navigation
            window.addEventListener('popstate', function(event) {
                if (event.state) {
                    navigateTo(event.state.page, event.state.data);
                } else {
                    loadHomePage();
                }
            });

            // Handle keyboard shortcuts
            document.addEventListener('keydown', function(e) {
                if (e.key === 'ArrowRight' && currentPage === 'watch') {
                    changeEpisode('next');
                } else if (e.key === 'ArrowLeft' && currentPage === 'watch') {
                    changeEpisode('prev');
                } else if (e.key === ' ' && currentPage === 'watch') {
                    if (videoPlayer.paused) {
                        videoPlayer.play();
                    } else {
                        videoPlayer.pause();
                    }
                } else if (e.key === 'f' && currentPage === 'watch') {
                    if (videoPlayer.requestFullscreen) {
                        videoPlayer.requestFullscreen();
                    } else if (videoPlayer.webkitRequestFullscreen) {
                        videoPlayer.webkitRequestFullscreen();
                    } else if (videoPlayer.msRequestFullscreen) {
                        videoPlayer.msRequestFullscreen();
                    }
                }
            });
        }

        // CORS proxy function
        async function fetchWithCors(url) {
            try {
                // For Vercel deployment, we can use the built-in API routes as a proxy
                if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
                    // Local development - use direct fetch with no-cors (may not work for all APIs)
                    const response = await fetch(url, {
                        headers: {
                            'Accept': 'application/json',
                        }
                    });
                    return await response.json();
                } else {
                    // Production - use Vercel serverless function as proxy
                    const vercelProxyUrl = `/api/proxy?url=${encodeURIComponent(url)}`;
                    const response = await fetch(vercelProxyUrl);
                    return await response.json();
                }
            } catch (error) {
                console.error('Error fetching data:', error);
                return { success: false, error: error.message };
            }
        }

        // Navigation functions
        function navigateTo(page, data = {}) {
            // Hide all pages
            document.getElementById('home-page').style.display = 'none';
            document.getElementById('azlist-page').style.display = 'none';
            document.getElementById('category-page').style.display = 'none';
            document.getElementById('schedule-page').style.display = 'none';
            document.getElementById('anime-details').style.display = 'none';
            document.getElementById('watch-page').style.display = 'none';

            // Update current page
            currentPage = page;

            // Show loading indicator
            document.getElementById('loading').style.display = 'flex';

            // Show the requested page
            switch (page) {
                case 'home':
                    loadHomeData();
                    break;
                case 'azlist':
                    loadAZListPage(null, data.sortOption || 'all', data.page || 1);
                    break;
                case 'category':
                    loadCategoryPage(null, data.category || 'top-airing', data.page || 1);
                    break;
                case 'schedule':
                    loadSchedulePage();
                    break;
                case 'details':
                    loadAnimeDetails(data.animeId);
                    break;
                case 'watch':
                    loadWatchPage(data.animeId, data.episodeId, data.server, data.category);
                    break;
                default:
                    loadHomePage();
            }

            // Update URL
            updateUrl(page, data);
        }

        function updateUrl(page, data = {}) {
            let url = '/';
            let title = 'AniStream - Watch Anime Online';

            switch (page) {
                case 'home':
                    url = '/';
                    title = 'AniStream - Home';
                    break;
                case 'azlist':
                    url = `/azlist/${data.sortOption || 'all'}?page=${data.page || 1}`;
                    title = `AniStream - ${data.sortOption || 'All'} Anime`;
                    break;
                case 'category':
                    url = `/category/${data.category || 'top-airing'}?page=${data.page || 1}`;
                    title = `AniStream - ${formatCategoryName(data.category || 'top-airing')}`;
                    break;
                case 'schedule':
                    url = '/schedule';
                    title = 'AniStream - Schedule';
                    break;
                case 'details':
                    url = `/anime/${data.animeId}`;
                    title = `AniStream - ${data.animeName || 'Anime Details'}`;
                    break;
                case 'watch':
                    url = `/watch/${data.animeId}?ep=${data.episodeId}&server=${data.server || 'hd-1'}&cat=${data.category || 'sub'}`;
                    title = `AniStream - Watching ${data.animeName || 'Anime'}`;
                    break;
            }

            // Update browser history
            window.history.pushState({ page, data }, title, url);
            document.title = title;
        }

        // Page load functions
        function loadHomePage(event = null) {
            if (event) event.preventDefault();
            navigateTo('home');
        }

        function loadAZListPage(event = null, sortOption = 'all', page = 1) {
            if (event) event.preventDefault();
            navigateTo('azlist', { sortOption, page });
        }

        function loadCategoryPage(event = null, category = 'top-airing', page = 1) {
            if (event) event.preventDefault();
            navigateTo('category', { category, page });
        }

        function loadSchedulePage(event = null) {
            if (event) event.preventDefault();
            navigateTo('schedule');
        }

        function showAnimeDetails(event = null) {
            if (event) event.preventDefault();
            if (!currentAnimeId) return;
            navigateTo('details', { animeId: currentAnimeId });
        }

        function watchAnime(event = null, animeId = currentAnimeId, episodeId = '', server = 'hd-1', category = 'sub') {
            if (event) event.preventDefault();
            if (!animeId) return;
            navigateTo('watch', { animeId, episodeId, server, category });
        }

        function goBack(event = null) {
            if (event) event.preventDefault();
            window.history.back();
        }

        // Data loading functions
        async function loadHomeData() {
            try {
                // Show loading indicator
                document.getElementById('loading').style.display = 'flex';

                // Fetch home data
                const response = await fetchWithCors('https://aniwatch-api-net.vercel.app/api/v2/hianime/home');
                
                if (response.success) {
                    homeData = response.data;
                    renderHomePage();
                } else {
                    throw new Error('Failed to load home data');
                }
            } catch (error) {
                console.error('Error loading home data:', error);
                alert('Failed to load home data. Please try again later.');
            } finally {
                document.getElementById('loading').style.display = 'none';
            }
        }

        async function loadAZListData(sortOption, page = 1) {
            try {
                // Show loading indicator
                document.getElementById('loading').style.display = 'flex';

                // Fetch A-Z list data
                const response = await fetchWithCors(`https://aniwatch-api-net.vercel.app/api/v2/hianime/azlist/${sortOption}?page=${page}`);
                
                if (response.success) {
                    renderAZListPage(response.data, sortOption, page);
                } else {
                    throw new Error('Failed to load A-Z list data');
                }
            } catch (error) {
                console.error('Error loading A-Z list data:', error);
                alert('Failed to load A-Z list data. Please try again later.');
            } finally {
                document.getElementById('loading').style.display = 'none';
            }
        }

        async function loadCategoryData(category, page = 1) {
            try {
                // Show loading indicator
                document.getElementById('loading').style.display = 'flex';

                // Fetch category data
                const response = await fetchWithCors(`https://aniwatch-api-net.vercel.app/api/v2/hianime/category/${category}?page=${page}`);
                
                if (response.success) {
                    renderCategoryPage(response.data, category, page);
                } else {
                    throw new Error('Failed to load category data');
                }
            } catch (error) {
                console.error('Error loading category data:', error);
                alert('Failed to load category data. Please try again later.');
            } finally {
                document.getElementById('loading').style.display = 'none';
            }
        }

        async function loadScheduleData(date = null) {
            try {
                // Show loading indicator
                document.getElementById('loading').style.display = 'flex';

                // Use current date if not provided
                if (!date) {
                    const today = new Date();
                    date = today.toISOString().split('T')[0];
                    document.getElementById('schedule-date').value = date;
                }

                // Fetch schedule data
                const response = await fetchWithCors(`https://aniwatch-api-net.vercel.app/api/v2/hianime/schedule?date=${date}`);
                
                if (response.success) {
                    renderSchedulePage(response.data, date);
                } else {
                    throw new Error('Failed to load schedule data');
                }
            } catch (error) {
                console.error('Error loading schedule data:', error);
                alert('Failed to load schedule data. Please try again later.');
            } finally {
                document.getElementById('loading').style.display = 'none';
            }
        }

        async function loadAnimeDetails(animeId) {
            try {
                // Show loading indicator
                document.getElementById('loading').style.display = 'flex';

                currentAnimeId = animeId;

                // Fetch anime details
                const detailsResponse = await fetchWithCors(`https://aniwatch-api-net.vercel.app/api/v2/hianime/anime/${animeId}`);
                const qtipResponse = await fetchWithCors(`https://aniwatch-api-net.vercel.app/api/v2/hianime/qtip/${animeId}`);
                const episodesResponse = await fetchWithCors(`https://aniwatch-api-net.vercel.app/api/v2/hianime/anime/${animeId}/episodes`);

                if (detailsResponse.success && qtipResponse.success && episodesResponse.success) {
                    animeDetails = {
                        details: detailsResponse.data,
                        qtip: qtipResponse.data,
                        episodes: episodesResponse.data
                    };
                    episodesList = animeDetails.episodes.episodes;
                    renderAnimeDetails();
                } else {
                    throw new Error('Failed to load anime details');
                }
            } catch (error) {
                console.error('Error loading anime details:', error);
                alert('Failed to load anime details. Please try again later.');
            } finally {
                document.getElementById('loading').style.display = 'none';
            }
        }

        async function loadWatchPage(animeId, episodeId = '', server = 'hd-1', category = 'sub') {
            try {
                // Show loading indicator
                document.getElementById('loading').style.display = 'flex';

                currentAnimeId = animeId;
                currentServer = server;
                currentCategory = category;

                // If episodeId is not provided, get the first episode
                if (!episodeId) {
                    const episodesResponse = await fetchWithCors(`https://aniwatch-api-net.vercel.app/api/v2/hianime/anime/${animeId}/episodes`);
                    if (episodesResponse.success && episodesResponse.data.episodes.length > 0) {
                        episodeId = episodesResponse.data.episodes[0].episodeId;
                        currentEpisodeNumber = 1;
                    } else {
                        throw new Error('No episodes found');
                    }
                }

                currentEpisodeId = episodeId;

                // Fetch episode servers
                const serversResponse = await fetchWithCors(`https://aniwatch-api-net.vercel.app/api/v2/hianime/episode/servers?animeEpisodeId=${episodeId}`);
                
                if (serversResponse.success) {
                    serversList = serversResponse.data;
                    renderWatchPage();
                } else {
                    throw new Error('Failed to load episode servers');
                }
            } catch (error) {
                console.error('Error loading watch page:', error);
                alert('Failed to load watch page. Please try again later.');
            } finally {
                document.getElementById('loading').style.display = 'none';
            }
        }

        async function loadEpisodeSources(episodeId, server, category) {
            try {
                // Show loading indicator
                document.getElementById('loading').style.display = 'flex';

                // Fetch episode sources
                const response = await fetchWithCors(`https://aniwatch-api-net.vercel.app/api/v2/hianime/episode/sources?animeEpisodeId=${episodeId}&server=${server}&category=${category}`);
                
                if (response.success) {
                    return response.data;
                } else {
                    throw new Error('Failed to load episode sources');
                }
            } catch (error) {
                console.error('Error loading episode sources:', error);
                throw error;
            } finally {
                document.getElementById('loading').style.display = 'none';
            }
        }

        async function searchAnime(query) {
            if (!query || query.length < 3) {
                document.querySelector('.search-results').style.display = 'none';
                return;
            }

            try {
                const response = await fetchWithCors(`https://aniwatch-api-net.vercel.app/api/v2/hianime/search/suggestion?q=${encodeURIComponent(query)}`);
                
                if (response.success) {
                    renderSearchResults(response.data.suggestions);
                }
            } catch (error) {
                console.error('Error searching anime:', error);
            }
        }

        async function loadAIRecommendations() {
            try {
                // Show loading indicator
                document.getElementById('ai-recommendations').innerHTML = '<div class="loading"><div class="loading-spinner"></div></div>';

                // Simulate AI recommendations by mixing popular and trending anime
                let recommendations = [];
                
                if (homeData) {
                    // Mix spotlight, trending and popular anime
                    if (homeData.spotlightAnimes && homeData.spotlightAnimes.length > 0) {
                        recommendations.push(homeData.spotlightAnimes[0]);
                    }
                    
                    if (homeData.trendingAnimes && homeData.trendingAnimes.length > 0) {
                        recommendations = recommendations.concat(homeData.trendingAnimes.slice(0, 3));
                    }
                    
                    if (homeData.mostPopularAnimes && homeData.mostPopularAnimes.length > 0) {
                        recommendations = recommendations.concat(homeData.mostPopularAnimes.slice(0, 3));
                    }
                    
                    if (homeData.topAiringAnimes && homeData.topAiringAnimes.length > 0) {
                        recommendations = recommendations.concat(homeData.topAiringAnimes.slice(0, 3));
                    }

                    // Shuffle the array
                    recommendations = shuffleArray(recommendations);

                    renderAnimeList(recommendations, 'ai-recommendations');
                }
            } catch (error) {
                console.error('Error generating AI recommendations:', error);
                document.getElementById('ai-recommendations').innerHTML = '<p>Failed to load recommendations. Please try again.</p>';
            }
        }

        // Helper functions
        function formatCategoryName(category) {
            const nameMap = {
                'most-favorite': 'Most Favorite',
                'most-popular': 'Most Popular',
                'subbed-anime': 'Subbed Anime',
                'dubbed-anime': 'Dubbed Anime',
                'recently-updated': 'Recently Updated',
                'recently-added': 'Recently Added',
                'top-upcoming': 'Top Upcoming',
                'top-airing': 'Top Airing',
                'movie': 'Movies',
                'special': 'Specials',
                'ova': 'OVAs',
                'ona': 'ONAs',
                'tv': 'TV Series',
                'completed': 'Completed Anime'
            };
            return nameMap[category] || category.split('-').map(word => word.charAt(0).toUpperCase() + word.slice(1)).join(' ');
        }

        function formatDuration(duration) {
            if (!duration) return 'N/A';
            return duration.replace('min per ep', 'min/ep');
        }

        function formatDate(dateString) {
            if (!dateString) return 'N/A';
            const date = new Date(dateString);
            return date.toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });
        }

        function shuffleArray(array) {
            const newArray = [...array];
            for (let i = newArray.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [newArray[i], newArray[j]] = [newArray[j], newArray[i]];
            }
            return newArray;
        }

        function toggleSearch() {
            const searchContainer = document.querySelector('.search-container');
            if (window.innerWidth <= 576) {
                if (searchContainer.style.display === 'block') {
                    searchContainer.style.display = 'none';
                } else {
                    searchContainer.style.display = 'block';
                    document.querySelector('.search-input').focus();
                }
            }
        }

        // Rendering functions
        function renderHomePage() {
            if (!homeData) return;

            // Show home page
            document.getElementById('home-page').style.display = 'block';

            // Render spotlight anime
            if (homeData.spotlightAnimes && homeData.spotlightAnimes.length > 0) {
                const spotlight = homeData.spotlightAnimes[0];
                currentAnimeId = spotlight.id;

                document.getElementById('spotlight-poster').src = spotlight.poster;
                document.getElementById('spotlight-title').textContent = spotlight.name;
                document.getElementById('spotlight-jtitle').textContent = spotlight.jname;
                document.getElementById('spotlight-description').textContent = spotlight.description;

                // Update background image
                document.querySelector('.spotlight-bg').style.backgroundImage = `url(${spotlight.poster})`;

                // Render meta info
                const metaContainer = document.getElementById('spotlight-meta');
                metaContainer.innerHTML = '';

                if (spotlight.otherInfo && spotlight.otherInfo.length > 0) {
                    spotlight.otherInfo.forEach(info => {
                        const metaItem = document.createElement('div');
                        metaItem.className = 'spotlight-meta-item';
                        metaItem.innerHTML = `<i class="fas fa-circle"></i><span>${info}</span>`;
                        metaContainer.appendChild(metaItem);
                    });
                }
            }

            // Render latest episodes
            if (homeData.latestEpisodeAnimes && homeData.latestEpisodeAnimes.length > 0) {
                renderAnimeList(homeData.latestEpisodeAnimes, 'latest-episodes');
            }

            // Render top 10 anime
            if (homeData.top10Animes && homeData.top10Animes.today && homeData.top10Animes.today.length > 0) {
                const top10Container = document.getElementById('top10-anime');
                top10Container.innerHTML = '';

                homeData.top10Animes.today.forEach((anime, index) => {
                    const top10Item = document.createElement('div');
                    top10Item.className = 'top10-item';
                    top10Item.onclick = () => {
                        currentAnimeId = anime.id;
                        showAnimeDetails();
                    };

                    top10Item.innerHTML = `
                        <div class="top10-item-rank">${index + 1}</div>
                        <div class="top10-item-poster">
                            <img src="${anime.poster}" alt="${anime.name}">
                        </div>
                        <div class="top10-item-info">
                            <div class="top10-item-title">${anime.name}</div>
                            <div class="top10-item-meta">
                                ${anime.episodes.sub ? `Sub: ${anime.episodes.sub}` : ''}
                                ${anime.episodes.dub ? `Dub: ${anime.episodes.dub}` : ''}
                            </div>
                        </div>
                    `;

                    top10Container.appendChild(top10Item);
                });
            }

            // Render trending anime
            if (homeData.trendingAnimes && homeData.trendingAnimes.length > 0) {
                renderAnimeList(homeData.trendingAnimes, 'trending-anime');
            }

            // Render top airing anime
            if (homeData.topAiringAnimes && homeData.topAiringAnimes.length > 0) {
                renderAnimeList(homeData.topAiringAnimes, 'top-airing');
            }

            // Load AI recommendations
            loadAIRecommendations();
        }

        function renderAZListPage(data, sortOption, page) {
            // Show A-Z list page
            document.getElementById('azlist-page').style.display = 'block';

            // Update title
            const title = sortOption === 'all' ? 'All Anime' : 
                         sortOption === 'other' ? 'Other' : 
                         sortOption === '0-9' ? '0-9' : 
                         `${sortOption.toUpperCase()} Anime`;
            document.getElementById('azlist-title').textContent = title;

            // Update pagination info
            azListCurrentPage = page;
            azListTotalPages = data.totalPages;
            azListSortOption = sortOption;

            document.getElementById('azlist-page-info').textContent = `Page ${page} of ${data.totalPages}`;
            document.getElementById('azlist-prev').disabled = page <= 1;
            document.getElementById('azlist-next').disabled = page >= data.totalPages;

            // Render anime list
            if (data.animes && data.animes.length > 0) {
                renderAnimeList(data.animes, 'azlist-anime');
            } else {
                document.getElementById('azlist-anime').innerHTML = '<p>No anime found for this category.</p>';
            }
        }

        function renderCategoryPage(data, category, page) {
            // Show category page
            document.getElementById('category-page').style.display = 'block';

            // Update title
            document.getElementById('category-title').textContent = data.category || formatCategoryName(category);

            // Update pagination info
            categoryCurrentPage = page;
            categoryTotalPages = data.totalPages;
            categoryName = category;

            document.getElementById('category-page-info').textContent = `Page ${page} of ${data.totalPages}`;
            document.getElementById('category-prev').disabled = page <= 1;
            document.getElementById('category-next').disabled = page >= data.totalPages;

            // Render anime list
            if (data.animes && data.animes.length > 0) {
                renderAnimeList(data.animes, 'category-anime');
            } else {
                document.getElementById('category-anime').innerHTML = '<p>No anime found for this category.</p>';
            }
        }

        function renderSchedulePage(data, date) {
            // Show schedule page
            document.getElementById('schedule-page').style.display = 'block';

            // Render schedule
            const scheduleContainer = document.getElementById('schedule-anime');
            scheduleContainer.innerHTML = '';

            if (data.scheduledAnimes && data.scheduledAnimes.length > 0) {
                // Group by time
                const timeGroups = {};
                data.scheduledAnimes.forEach(anime => {
                    if (!timeGroups[anime.time]) {
                        timeGroups[anime.time] = [];
                    }
                    timeGroups[anime.time].push(anime);
                });

                // Render each time group
                for (const [time, animes] of Object.entries(timeGroups)) {
                    const timeGroup = document.createElement('div');
                    timeGroup.style.marginBottom = '2rem';

                    const timeHeader = document.createElement('h3');
                    timeHeader.style.fontSize = '1.2rem';
                    timeHeader.style.marginBottom = '1rem';
                    timeHeader.style.color = 'var(--primary)';
                    timeHeader.textContent = time;
                    timeGroup.appendChild(timeHeader);

                    const animeList = document.createElement('div');
                    animeList.className = 'anime-list';

                    animes.forEach(anime => {
                        const animeCard = document.createElement('div');
                        animeCard.className = 'anime-card';
                        animeCard.onclick = () => {
                            currentAnimeId = anime.id;
                            showAnimeDetails();
                        };

                        animeCard.innerHTML = `
                            <div class="anime-card-poster">
                                <img src="${anime.poster || 'https://via.placeholder.com/180x250'}" alt="${anime.name}">
                            </div>
                            <div class="anime-card-info">
                                <h3 class="anime-card-title">${anime.name}</h3>
                                <div class="anime-card-meta">
                                    <span>${anime.jname || ''}</span>
                                </div>
                            </div>
                        `;

                        animeList.appendChild(animeCard);
                    });

                    timeGroup.appendChild(animeList);
                    scheduleContainer.appendChild(timeGroup);
                }
            } else {
                scheduleContainer.innerHTML = '<p>No anime scheduled for this date.</p>';
            }
        }

        function renderAnimeDetails() {
            if (!animeDetails) return;

            // Show anime details page
            document.getElementById('anime-details').style.display = 'block';

            const details = animeDetails.details.anime.info;
            const qtip = animeDetails.qtip.anime;
            const episodes = animeDetails.episodes;

            // Update title
            document.getElementById('details-title').textContent = details.name || qtip.name;

            // Render poster
            document.getElementById('details-poster').src = details.poster || qtip.poster;

            // Render title
            document.getElementById('details-name').textContent = details.name || qtip.name;
            document.getElementById('details-jname').textContent = details.jname || qtip.jname;

            // Render meta info
            const metaContainer = document.getElementById('details-meta');
            metaContainer.innerHTML = '';

            if (details.stats) {
                const metaItems = [
                    { icon: 'star', text: details.stats.rating || 'N/A' },
                    { icon: 'tv', text: details.stats.type || 'N/A' },
                    { icon: 'clock', text: formatDuration(details.stats.duration) },
                    { icon: 'play-circle', text: `Sub: ${details.stats.episodes.sub || 0} | Dub: ${details.stats.episodes.dub || 0}` }
                ];

                metaItems.forEach(item => {
                    const metaItem = document.createElement('div');
                    metaItem.className = 'anime-details-meta-item';
                    metaItem.innerHTML = `<i class="fas fa-${item.icon}"></i><span>${item.text}</span>`;
                    metaContainer.appendChild(metaItem);
                });
            }

            // Render stats
            document.getElementById('details-rating').textContent = qtip.malscore || 'N/A';
            document.getElementById('details-quality').textContent = qtip.quality || 'N/A';
            document.getElementById('details-episodes').textContent = episodes.totalEpisodes || 'N/A';

            // Render description
            document.getElementById('details-description').textContent = qtip.description || details.description || 'No description available.';

            // Render genres
            const genresContainer = document.getElementById('details-genres');
            genresContainer.innerHTML = '';

            const genres = qtip.genres || (animeDetails.details.anime.moreInfo && animeDetails.details.anime.moreInfo.genres) || [];
            genres.forEach(genre => {
                const genreElement = document.createElement('div');
                genreElement.className = 'anime-details-genre';
                genreElement.textContent = genre;
                genresContainer.appendChild(genreElement);
            });

            // Render more info
            const moreInfoContainer = document.getElementById('details-more-info');
            moreInfoContainer.innerHTML = '';

            if (animeDetails.details.anime.moreInfo) {
                const moreInfo = animeDetails.details.anime.moreInfo;
                const infoItems = [
                    { label: 'Aired', value: moreInfo.aired || qtip.aired },
                    { label: 'Status', value: moreInfo.status || qtip.status },
                    { label: 'Studios', value: moreInfo.studios },
                    { label: 'Duration', value: formatDuration(moreInfo.duration) },
                    { label: 'Synonyms', value: qtip.synonyms }
                ];

                infoItems.forEach(item => {
                    if (item.value) {
                        const infoItem = document.createElement('div');
                        infoItem.style.marginBottom = '0.5rem';
                        infoItem.innerHTML = `<strong>${item.label}:</strong> ${item.value}`;
                        moreInfoContainer.appendChild(infoItem);
                    }
                });
            }

            // Render episodes
            const episodesContainer = document.getElementById('details-episodes-list');
            episodesContainer.innerHTML = '';

            if (episodes.episodes && episodes.episodes.length > 0) {
                episodes.episodes.forEach((episode, index) => {
                    const episodeElement = document.createElement('div');
                    episodeElement.className = 'anime-details-episode';
                    episodeElement.onclick = () => {
                        watchAnime(null, currentAnimeId, episode.episodeId);
                    };

                    episodeElement.innerHTML = `
                        <div class="anime-details-episode-number">${episode.number}</div>
                        <div class="anime-details-episode-title">${episode.title || `Episode ${episode.number}`}</div>
                        <div class="anime-details-episode-actions">
                            <button class="btn btn-icon" onclick="event.stopPropagation(); watchAnime(null, '${currentAnimeId}', '${episode.episodeId}', 'hd-1', 'sub')">
                                <i class="fas fa-play"></i>
                            </button>
                            ${episode.isFiller ? '<span class="anime-details-episode-filler">Filler</span>' : ''}
                        </div>
                    `;

                    episodesContainer.appendChild(episodeElement);
                });
            } else {
                episodesContainer.innerHTML = '<p>No episodes available.</p>';
            }

            // Render recommended anime
            if (animeDetails.details.recommendedAnimes && animeDetails.details.recommendedAnimes.length > 0) {
                renderAnimeList(animeDetails.details.recommendedAnimes, 'details-recommended');
            }
        }

        async function renderWatchPage() {
            // Show watch page
            document.getElementById('watch-page').style.display = 'block';

            // Update anime title
            document.getElementById('watch-anime-title').textContent = animeDetails?.details?.anime?.info?.name || 'Watching Anime';

            // Update episode title and number
            const currentEpisode = episodesList.find(ep => ep.episodeId === currentEpisodeId);
            if (currentEpisode) {
                document.getElementById('watch-episode-title').textContent = currentEpisode.title || `Episode ${currentEpisode.number}`;
                document.getElementById('episode-number').textContent = currentEpisode.number;
                currentEpisodeNumber = currentEpisode.number;
            }

            // Render server selector
            const serverSelector = document.getElementById('server-selector');
            serverSelector.innerHTML = '';

            const availableServers = serversList[currentCategory] || [];
            availableServers.forEach(server => {
                const serverElement = document.createElement('div');
                serverElement.className = `watch-server ${server.serverName === currentServer ? 'active' : ''}`;
                serverElement.textContent = server.serverName;
                serverElement.onclick = () => {
                    currentServer = server.serverName;
                    loadEpisode();
                };
                serverSelector.appendChild(serverElement);
            });

            // Render episode list
            const episodeListContainer = document.getElementById('episode-list');
            episodeListContainer.innerHTML = '';

            if (episodesList && episodesList.length > 0) {
                episodesList.forEach(episode => {
                    const episodeElement = document.createElement('div');
                    episodeElement.className = `watch-episode ${episode.episodeId === currentEpisodeId ? 'active' : ''}`;
                    episodeElement.textContent = episode.number;
                    episodeElement.onclick = () => {
                        currentEpisodeId = episode.episodeId;
                        currentEpisodeNumber = episode.number;
                        loadEpisode();
                    };
                    episodeListContainer.appendChild(episodeElement);
                });
            }

            // Update navigation buttons
            document.getElementById('prev-episode').disabled = currentEpisodeNumber <= 1;
            document.getElementById('next-episode').disabled = currentEpisodeNumber >= episodesList.length;

            // Load the episode
            loadEpisode();
        }

        async function loadEpisode() {
            try {
                // Show loading indicator
                document.getElementById('loading').style.display = 'flex';

                // Clear previous video
                if (hls) {
                    hls.destroy();
                }
                videoPlayer.src = '';

                // Load episode sources
                const sources = await loadEpisodeSources(currentEpisodeId, currentServer, currentCategory);
                
                if (sources.sources && sources.sources.length > 0) {
                    // Find the best quality source
                    const preferredQualities = ['1080', '720', '480', '360', 'default'];
                    let selectedSource = null;

                    for (const quality of preferredQualities) {
                        selectedSource = sources.sources.find(source => 
                            source.quality && source.quality.includes(quality)
                        );
                        if (selectedSource) break;
                    }

                    // Fallback to first source if no preferred quality found
                    if (!selectedSource && sources.sources.length > 0) {
                        selectedSource = sources.sources[0];
                    }

                    if (selectedSource) {
                        // Play the video
                        if (Hls.isSupported()) {
                            hls = new Hls();
                            hls.loadSource(selectedSource.url);
                            hls.attachMedia(videoPlayer);
                            hls.on(Hls.Events.MANIFEST_PARSED, function() {
                                videoPlayer.play();
                            });
                        } else if (videoPlayer.canPlayType('application/vnd.apple.mpegurl')) {
                            // For Safari
                            videoPlayer.src = selectedSource.url;
                            videoPlayer.addEventListener('loadedmetadata', function() {
                                videoPlayer.play();
                            });
                        } else {
                            throw new Error('HLS is not supported in this browser');
                        }

                        // Load subtitles if available
                        if (sources.subtitles && sources.subtitles.length > 0) {
                            sources.subtitles.forEach(subtitle => {
                                const track = document.createElement('track');
                                track.kind = 'subtitles';
                                track.label = subtitle.lang;
                                track.srclang = subtitle.lang.toLowerCase();
                                track.src = subtitle.url;
                                videoPlayer.appendChild(track);
                            });
                        }
                    } else {
                        throw new Error('No playable sources found');
                    }
                } else {
                    throw new Error('No sources available for this episode');
                }
            } catch (error) {
                console.error('Error loading episode:', error);
                alert('Failed to load episode. Please try another server or check back later.');
            } finally {
                document.getElementById('loading').style.display = 'none';
            }
        }

        function renderSearchResults(suggestions) {
            const resultsContainer = document.querySelector('.search-results');
            resultsContainer.innerHTML = '';

            if (suggestions && suggestions.length > 0) {
                suggestions.forEach(item => {
                    const resultItem = document.createElement('div');
                    resultItem.className = 'search-result-item';
                    resultItem.onclick = () => {
                        currentAnimeId = item.id;
                        showAnimeDetails();
                        resultsContainer.style.display = 'none';
                    };

                    resultItem.innerHTML = `
                        <img src="${item.poster}" alt="${item.name}">
                        <div class="search-result-item-info">
                            <div class="search-result-item-title">${item.name}</div>
                            <div class="search-result-item-meta">
                                ${item.jname || ''}
                                ${item.moreInfo && item.moreInfo.length > 0 ? ` ${item.moreInfo.join('  ')}` : ''}
                            </div>
                        </div>
                    `;

                    resultsContainer.appendChild(resultItem);
                });

                resultsContainer.style.display = 'block';
            } else {
                resultsContainer.style.display = 'none';
            }
        }

        function renderAnimeList(animes, containerId) {
            const container = document.getElementById(containerId);
            container.innerHTML = '';

            if (animes && animes.length > 0) {
                animes.forEach(anime => {
                    const animeCard = document.createElement('div');
                    animeCard.className = 'anime-card';
                    animeCard.onclick = () => {
                        currentAnimeId = anime.id;
                        showAnimeDetails();
                    };

                    let badge = '';
                    if (anime.rank) {
                        badge = `<div class="anime-card-badge">#${anime.rank}</div>`;
                    }

                    let dubBadge = '';
                    if (anime.episodes && anime.episodes.dub > 0) {
                        dubBadge = '<div class="anime-card-dub-badge">DUB</div>';
                    }

                    animeCard.innerHTML = `
                        <div class="anime-card-poster">
                            <img src="${anime.poster}" alt="${anime.name}">
                            ${badge}
                            ${dubBadge}
                        </div>
                        <div class="anime-card-info">
                            <h3 class="anime-card-title">${anime.name}</h3>
                            <div class="anime-card-meta">
                                <span>${anime.type || ''}</span>
                                <span>
                                    ${anime.episodes?.sub ? `Sub: ${anime.episodes.sub}` : ''}
                                    ${anime.episodes?.dub ? ` Dub: ${anime.episodes.dub}` : ''}
                                </span>
                            </div>
                        </div>
                    `;

                    container.appendChild(animeCard);
                });
            } else {
                container.innerHTML = '<p>No anime found.</p>';
            }
        }

        // Pagination functions
        function changeAZListPage(direction) {
            let newPage = azListCurrentPage;
            if (direction === 'prev' && azListCurrentPage > 1) {
                newPage = azListCurrentPage - 1;
            } else if (direction === 'next' && azListCurrentPage < azListTotalPages) {
                newPage = azListCurrentPage + 1;
            }

            if (newPage !== azListCurrentPage) {
                loadAZListData(azListSortOption, newPage);
            }
        }

        function changeCategoryPage(direction) {
            let newPage = categoryCurrentPage;
            if (direction === 'prev' && categoryCurrentPage > 1) {
                newPage = categoryCurrentPage - 1;
            } else if (direction === 'next' && categoryCurrentPage < categoryTotalPages) {
                newPage = categoryCurrentPage + 1;
            }

            if (newPage !== categoryCurrentPage) {
                loadCategoryData(categoryName, newPage);
            }
        }

        // Episode navigation
        function changeEpisode(direction) {
            if (!episodesList || episodesList.length === 0) return;

            let newEpisodeNumber = currentEpisodeNumber;
            if (direction === 'prev' && currentEpisodeNumber > 1) {
                newEpisodeNumber = currentEpisodeNumber - 1;
            } else if (direction === 'next' && currentEpisodeNumber < episodesList.length) {
                newEpisodeNumber = currentEpisodeNumber + 1;
            }

            if (newEpisodeNumber !== currentEpisodeNumber) {
                const newEpisode = episodesList.find(ep => ep.number === newEpisodeNumber);
                if (newEpisode) {
                    currentEpisodeId = newEpisode.episodeId;
                    currentEpisodeNumber = newEpisodeNumber;
                    loadEpisode();
                }
            }
        }

        // Schedule functions
        function loadSchedule() {
            const date = document.getElementById('schedule-date').value;
            if (date) {
                loadScheduleData(date);
            }
        }

        // Initialize the app
        function initApp() {
            // Check URL on initial load
            const path = window.location.pathname;
            const params = new URLSearchParams(window.location.search);

            if (path === '/' || path === '') {
                loadHomePage();
            } else if (path.startsWith('/azlist/')) {
                const sortOption = path.split('/')[2];
                const page = parseInt(params.get('page')) || 1;
                loadAZListPage(null, sortOption, page);
            } else if (path.startsWith('/category/')) {
                const category = path.split('/')[2];
                const page = parseInt(params.get('page')) || 1;
                loadCategoryPage(null, category, page);
            } else if (path.startsWith('/schedule')) {
                loadSchedulePage();
            } else if (path.startsWith('/anime/')) {
                const animeId = path.split('/')[2];
                loadAnimeDetails(animeId);
            } else if (path.startsWith('/watch/')) {
                const animeId = path.split('/')[2];
                const episodeId = params.get('ep');
                const server = params.get('server') || 'hd-1';
                const category = params.get('cat') || 'sub';
                watchAnime(null, animeId, episodeId, server, category);
            } else {
                loadHomePage();
            }
        }

        // Start the app
        initApp();
    </script>
</body>
</html>
